name: home-server

services:
  grafana:
    image: grafana/grafana:11.5.2
    container_name: grafana
    volumes:
      - grafana-data:/var/lib/grafana
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - TZ=${TIMEZONE}
    ports:
      - '3000:3000'
    restart: unless-stopped

  home-assistant:
    image: homeassistant/home-assistant:2025.2.5
    container_name: home-assistant
    volumes:
      - ${HOME_ASSISTANT_CONFIGURATION_DIRECTORY}:/config
      - ../home-server-configuration/home-assistant/configuration.yaml:/config/configuration.yaml
      - ../home-server-configuration/home-assistant/automations.yaml:/config/automations.yaml
      - /etc/localtime:/etc/localtime:ro
    environment:
      - TZ=${TIMEZONE}
    network_mode: host
    restart: unless-stopped

  momomo:
    image: alexmikhalochkin/momomo-worker:main
    container_name: momomo
    depends_on:
      - mosquitto
    volumes:
      - ../home-server-configuration/momomo/application.yaml:/config/application.yaml
    environment:
      - TZ=${TIMEZONE}
    command: --spring.config.location=/config/
    restart: unless-stopped

  mosquitto:
    image: alexmikhalochkin/mosquitto:main
    container_name: mosquitto
    volumes:
      - ../home-server-configuration/mosquitto:/etc/mosquitto/certs
    environment:
      - TZ=${TIMEZONE}
      - BRIDGE_ADDRESS=${AWS_IOT_BRIDGE_ADDRESS}
    ports:
      - '1883:1883'
    restart: unless-stopped

  node-exporter:
    image: prom/node-exporter:v1.9.0
    container_name: node-exporter
    volumes:
      - /:/host:ro,rslave
    environment:
      - TZ=${TIMEZONE}
    ports:
      - '9100:9100'
    command:
      - '--path.rootfs=/host'
    restart: unless-stopped
    pid: host

  plex:
    image: linuxserver/plex:1.41.4
    container_name: plex
    volumes:
      - ${PLEX_CONFIG_DIRECTORY}/config:/config
      - ${PLEX_CONTENT_DIRECTORY}/content:/content
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TIMEZONE}
      - VERSION=docker
    network_mode: host
    restart: unless-stopped
    devices:
      - /dev/dri:/dev/dri

  prometheus:
    image: prom/prometheus:v3.2.1
    container_name: prometheus
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    environment:
      - TZ=${TIMEZONE}
    ports:
      - '9090:9090'
    command:
      - --config.file=/etc/prometheus/prometheus.yml
    restart: unless-stopped

  zigbee2mqtt:
    image: koenkk/zigbee2mqtt:2.1.1
    container_name: zigbee2mqtt
    depends_on:
      - mosquitto
    volumes:
      - ../home-server-configuration/zigbee2mqtt/coordinator_backup.json:/app/data/coordinator_backup.json
      - ../home-server-configuration/zigbee2mqtt/configuration.yaml:/app/data/configuration.yaml
      - ../home-server-configuration/zigbee2mqtt/database.db:/app/data/database.db
      - /run/udev:/run/udev:ro
    environment:
      - TZ=${TIMEZONE}
    ports:
      - '8080:8080'
    restart: unless-stopped
    devices:
      - /dev/ttyUSB0:/dev/ttyUSB0

volumes:
  grafana-data:
  prometheus-data:
