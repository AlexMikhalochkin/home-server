# kics-scan disable=698ed579-b239-4f8f-a388-baa4bcb13ef8,451d79dc-0588-476a-ad03-3c7f0320abb3
# disable queries: health check, container traffic not bound to host interface
name: home-server

services:
  dozzle:
    image: amir20/dozzle:v8.10.5
    container_name: dozzle
    volumes:
      # kics-scan ignore-line
      - /var/run/docker.sock:/var/run/docker.sock:ro
    ports:
      - '${HOST_IP}:8888:8080'
    restart: unless-stopped
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true

  grafana:
    image: grafana/grafana:11.5.2
    container_name: grafana
    volumes:
      # kics-scan ignore-line
      - grafana-data:/var/lib/grafana
    environment:
      - TZ=${TIMEZONE}
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
      - GF_AUTH_DISABLE_LOGIN_FORM=true
    ports:
      - '${HOST_IP}:3000:3000'
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:3000/api/health"
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true

  home-assistant:
    image: homeassistant/home-assistant:2025.2.5
    container_name: home-assistant
    volumes:
      - ${HOME_ASSISTANT_CONFIGURATION_DIRECTORY}:/config
      - ../home-server-configuration/home-assistant/configuration.yaml:/config/configuration.yaml
      - ../home-server-configuration/home-assistant/automations.yaml:/config/automations.yaml
    environment:
      - TZ=${TIMEZONE}
    network_mode: "service:openvpn"
    restart: unless-stopped
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true

  matterbridge:
    image: luligu/matterbridge:3.4.6
    container_name: matterbridge
    volumes:
      - ../home-server-configuration/Matterbridge:/root/Matterbridge
      - ../home-server-configuration/.matterbridge:/root/.matterbridge
    # kics-scan ignore-line
    network_mode: host
    restart: always
    # kics-scan ignore-line
    cap_add:
      - NET_BIND_SERVICE
      - NET_RAW
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true

  mosquitto:
    image: eclipse-mosquitto:2.0.20
    container_name: mosquitto
    volumes:
      - ../home-server-configuration/mosquitto/certs:/etc/mosquitto/certs
      - ../home-server-configuration/mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf
    environment:
      - TZ=${TIMEZONE}
    ports:
      - '1883:1883'
    restart: unless-stopped
    user: 1000:1000
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true

  node-exporter:
    image: prom/node-exporter:v1.9.0
    container_name: node-exporter
    volumes:
      # kics-scan ignore-line
      - /:/host:ro,rslave
    environment:
      - TZ=${TIMEZONE}
    command:
      - '--path.rootfs=/host'
    restart: unless-stopped
    cap_drop:
      - ALL
    # Required for node-exporter to collect host process metrics
    # kics-scan ignore-line
    pid: host
    security_opt:
      - no-new-privileges:true

  plex:
    image: linuxserver/plex:1.42.2
    container_name: plex
    volumes:
      - ${PLEX_CONFIG_DIRECTORY}/config:/config
      - ${PLEX_CONTENT_DIRECTORY}/content:/content
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TIMEZONE}
      - VERSION=docker
    # kics-scan ignore-line
    network_mode: host
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:32400/identity" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    # kics-scan ignore-line
    cap_add:
      - SETUID
      - SETGID
      - CHOWN
    cap_drop:
      - ALL
    devices:
      - /dev/dri:/dev/dri
    security_opt:
      - no-new-privileges:true

  prometheus:
    image: prom/prometheus:v3.2.1
    container_name: prometheus
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      # kics-scan ignore-line
      - prometheus-data:/prometheus
    environment:
      - TZ=${TIMEZONE}
    command:
      - --config.file=/etc/prometheus/prometheus.yml
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:9090/-/healthy"
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true

  zigbee2mqtt:
    image: koenkk/zigbee2mqtt:2.1.1
    container_name: zigbee2mqtt
    volumes:
      - ../home-server-configuration/zigbee2mqtt:/app/data
    environment:
      - TZ=${TIMEZONE}
    ports:
      - '${HOST_IP}:8080:8080'
    restart: unless-stopped
    user: 1000:1000
    cap_drop:
      - ALL
    devices:
      - /dev/ttyUSB0:/dev/ttyUSB0
    group_add:
      - dialout
    security_opt:
      - no-new-privileges:true

volumes:
  grafana-data:
  prometheus-data:
